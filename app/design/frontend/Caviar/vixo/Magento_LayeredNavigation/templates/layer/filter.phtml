<?php
/** @var \Magento\Framework\Escaper $escaper */
/** @var \Magento\Framework\Locale\LocaleFormatter $localeFormatter */
/** @var \Magento\LayeredNavigation\ViewModel\Layer\Filter $viewModel */
$viewModel = $block->getData('product_layer_view_model');

$currentUrl = $_SERVER['REQUEST_URI']; // current page URL
$queryString = parse_url($currentUrl, PHP_URL_QUERY) ?: ''; // default to empty string
parse_str($queryString, $queryParams); // get query params

?>

<?php foreach ($filterItems as $filterItem): 
    // Extract the filter param from URL
    $filterUrl = $filterItem->getUrl();
    parse_str(parse_url($filterUrl, PHP_URL_QUERY), $filterItemParams);

    // Determine if this filter is active
    $isChecked = false;
    foreach ($filterItemParams as $key => $value) {
        if (isset($queryParams[$key]) && $queryParams[$key] == $value) {
            $isChecked = false;
            break;
        }
    }
?>
    <label>
        <input 
            type="checkbox" 
            class="layer-filter-checkbox" 
            data-url="<?= $escaper->escapeUrl($filterItem->getUrl()) ?>" 
        >
        <?= /* @noEscape */ $filterItem->getLabel() ?>
        <?php if ($viewModel->shouldDisplayProductCountOnLayer()): ?>
            <span class="count">
                <?= $localeFormatter->formatNumber((int) $filterItem->getCount()) ?>
            </span>
        <?php endif; ?>
    </label>
<?php endforeach; ?>
<script>
   require(['jquery'], function($){
    $(document).ready(function(){

        $('.layer-filter-checkbox').on('change', function(){
            var url = $(this).data('url');

            // Show loader
            $('#layered-loader').show();

            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'html',
                success: function(data){
                    // Replace product list
                    var products = $(data).find('.products.wrapper'); 
                    $('.products.wrapper').html(products.html());

                    // Replace filter sidebar (optional)
                    var filters = $(data).find('.filter-options-wrapper'); 
                    $('.filter-options-wrapper').html(filters.html());

                    // Update browser URL
                    history.pushState(null, '', url);
                },
                error: function(){
                    console.error('Failed to apply filter');
                },
                complete: function(){
                    // Hide loader
                    $('#layered-loader').hide();
                }
            });
        });

    });
});

    </script>
