<section class="shipping_cart-section">
    <div class="container cart-container">
        <div class="row g-4">

            <!-- Left Side -->
            <div class="col-lg-8">
                <div class="cart-box">
                    <div class="cart-title">
                        <img class="cart_icon" src="<?= $block->getViewFileUrl('images/cart/shipping cart vector.png'); ?>" alt="">
                        Shopping Cart (<?= count($block->getItems()) ?> items)
                    </div>

                    <?php foreach ($block->getItems() as $item): ?>
                        <div class="cart-item" data-item-id="<?= $item->getId() ?>">
                            <img src="<?= $block->getProductImage($item) ?>" alt="<?= $item->getName() ?>">
                            <div class="item-details">
                                <div class="item-title"><?= $item->getName() ?></div>
                                <div class="quantity-box">
                                    <form method="post" action="<?= $block->getUpdateUrl() ?>">
                                        <?= $block->getBlockHtml('formkey') ?>
                                        <div class="quantity-box">
                                            <span class="quantity-btn decrease">-</span>
                                            <input type="text" name="cart[<?= $item->getId() ?>][qty]" value="<?= $item->getQty() ?>" class="quantity-number">
                                            <span class="quantity-btn increase">+</span>
                                        </div>
                                        <button type="submit">Update</button>
                                    </form>
                                </div>
                            </div>
                            <div class="item-price">
                                <div class="price"><?= $block->getFormattedPrice($item->getRowTotal()) ?></div>
                                <a href="#"
                                   class="remove-btn action-delete"
                                   data-post='<?= $block->getRemovePostData($item) ?>'>
                                    <i class="fa-solid fa-trash-can"></i> Remove
                                </a>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>

                <div class="special-box">
                    <label class="special-label"><i class="fa-regular fa-message"></i> Special Instructions</label>
                    <textarea placeholder="Any special requests, gift messages, or packaging instructions..."></textarea>
                </div>
            </div>

            <!-- Right Side -->
            <div class="col-lg-4">
                <div class="promo-box" id="promo-box">
                    <label class="promo_label">
                        <img class="promo-img" src="<?= $block->getViewFileUrl('images/cart/promo tag.png'); ?>" alt="">
                        Promo Code
                    </label>
                    <div class="input_group">
                        <input type="text" id="promo-code" class="form-control" placeholder="Enter your promo code">
                        <button id="apply-promo" class="apply-btn">Apply</button>
                    </div>
                    <small class="promo-try text-muted d-block">Try: FIRST20</small>
                    <div id="promo-message" class="text-success mt-2"></div>
                </div>


                <div class="summary-box">
                    <div class="summary-title">Order Summary</div>
                    <div class="summary-row"><span>Subtotal</span><span><?= $block->getSubtotal() ?></span></div>
                    <div class="summary-total d-flex justify-content-between">
                        <span>TOTAL</span><span><?= $block->getGrandTotal() ?></span>
                    </div>
                    <a href="<?= $block->getUrl('checkout') ?>" class="checkout-btn">Proceed to Checkout</a>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
require([
    'jquery',
    'mage/url',
    'Magento_Customer/js/customer-data',
    'mage/dataPost',
    'domReady!'
], function($, urlBuilder, customerData) {
    'use strict';

    // --- Update Cart Totals ---
    function updateCartTotals() {
        $.getJSON(urlBuilder.build('checkout/cart/totals'), function(data) {
            if (data.subtotal) $('.summary-row span:last-child').text(data.subtotal);
            if (data.grand_total) $('.summary-total span:last-child').text(data.grand_total);
        }); 
    }

    // --- Quantity Buttons ---
    $(document).on('click', '.decrease, .increase', function() {
        var $input = $(this).siblings('.quantity-number');
        var $item = $(this).closest('.cart-item');
        var itemId = $item.data('item-id');
        var qty = parseInt($input.val()) || 0;

        if ($(this).hasClass('decrease') && qty > 0) qty--;
        if ($(this).hasClass('increase')) qty++;

        $input.val(qty);

        $.ajax({
            url: urlBuilder.build('checkout/cart/updatePost'),
            type: 'POST',
            data: {
                form_key: window.FORM_KEY,
                cart: { [itemId]: { qty: qty } }
            },
            success: function() {
                customerData.reload(['cart'], true);
                updateCartTotals();
            },
            error: function() {
                alert('Error updating quantity.');
            }
        });
    });

    // --- Remove Item ---
    $(document).on('click', '.remove-btn', function(e) {
        e.preventDefault();
        $.mage.dataPost($(this));
        $(document).one('ajaxComplete', function(e, xhr, settings) {
            if (settings.url.indexOf('/checkout/cart/delete') !== -1) {
                customerData.reload(['cart'], true);
                updateCartTotals();
            }
        });
    });

    // --- Apply Promo Code ---
    $(document).on('click', '.apply-btn', function(e) {
        e.preventDefault();

        var code = $('#promo-code').val().trim();
        if (!code) {
            $('.promo-msg').text('Please enter a promo code.').css('color', 'red');
            return;
        }

        $('.promo-msg').text('Applying...').css('color', 'gray');

        var $form = $('<form/>', {
            action: urlBuilder.build('checkout/cart/couponPost'),
            method: 'POST'
        }).append(
            $('<input/>', { type: 'hidden', name: 'form_key', value: window.FORM_KEY }),
            $('<input/>', { type: 'hidden', name: 'coupon_code', value: code }),
            $('<input/>', { type: 'hidden', name: 'remove', value: 0 })
        );

        $.mage.dataPost($form);
        $form.remove();

        $(document).one('ajaxComplete', function(e, xhr, settings) {
            if (settings.url.indexOf('/checkout/cart/couponPost') !== -1) {
                customerData.reload(['cart', 'messages'], true);
                updateCartTotals();
                $('.promo-msg').text('Promo code applied successfully!').css('color', 'green');
            }
        });
    });

    // --- Remove Promo Code ---
    $(document).on('click', '.remove-promo', function(e) {
        e.preventDefault();

        var $form = $('<form/>', {
            action: urlBuilder.build('checkout/cart/couponPost'),
            method: 'POST'
        }).append(
            $('<input/>', { type: 'hidden', name: 'form_key', value: window.FORM_KEY }),
            $('<input/>', { type: 'hidden', name: 'coupon_code', value: '' }),
            $('<input/>', { type: 'hidden', name: 'remove', value: 1 })
        );

        $.mage.dataPost($form);
        $form.remove();

        $(document).one('ajaxComplete', function(e, xhr, settings) {
            if (settings.url.indexOf('/checkout/cart/couponPost') !== -1) {
                $('#promo-code').val('');
                $('.promo-msg').text('Promo code removed.').css('color', 'gray');
                customerData.reload(['cart', 'messages'], true);
                updateCartTotals();
            }
        });
    });

    // --- Initial Totals Sync ---
    updateCartTotals();
});

</script>
